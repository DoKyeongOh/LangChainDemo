# 🎯 [P 3.0] 관련 정보 검색 및 필터링 상세 계획서

이 프로세스는 질문 분석 DTO를 바탕으로 Vector DB에서 관련 조항을 찾고, RDB와의 교차 검증을 통해 가장 정확한 '참조 컨텍스트 데이터'를 추출하는 시스템의 핵심 두뇌 역할을 수행합니다.

---

## 1. 하위 데이터 흐름도 (Level 2 DFD)

(아래 머메이드 코드를 복사하여 문서의 다이어그램 영역에 넣으세요.)

graph TD
    %% 데이터 엔티티 (사각형)
    MEM[Memory: 질의 분석 DTO]
    VDB["Vector DB: 임베딩 및 필터"]
    RDB[RDB: 규정 메타데이터]
    OUT[참조 컨텍스트 데이터]

    %% 프로세스 (타원형)
    P3_1(["3.1 메타데이터 필터 쿼리 생성"])
    P3_2(["3.2 유사도 검색 및 1차 필터링"])
    P3_3(["3.3 RDB 상세 정보 매핑 및 검증"])

    %% 데이터 흐름
    MEM -->|필터 파라미터| P3_1
    P3_1 --> P3_2
    P3_2 <-->|필터 기반 벡터 검색| VDB
    P3_2 -->|검색된 ID 리스트| P3_3
    P3_3 <-->|상세 메타데이터 조회| RDB
    P3_3 --> OUT


---

## 2. 단계별 상세 구현 가이드

### **3.1 메타데이터 필터 쿼리 생성**
* **목표**: 질문 분석 DTO(P 2.0)에 담긴 조건을 Vector DB 전용 쿼리문으로 변환합니다.
* **핵심 로직**: 분석된 `intent`와 `filters` 정보를 바탕으로 "대상=신입사원", "카테고리=인사"와 같은 **Pre-filtering** 조건을 생성합니다.
* **구현 방식**: LangChain4j의 `Filter` 객체를 활용하여 동적 필터 조건을 구성합니다.

### **3.2 유사도 검색 및 1차 필터링**
* **목표**: 1차로 필터링된 범위 안에서 사용자의 질문과 유사도가 높은 조항들을 추출합니다.
* **오버샘플링(Oversampling)**: 사후 필터링 및 검증 단계에서 조항이 탈락할 것을 대비하여, 실제 필요한 갯수보다 많은 양($k=20$ 등)을 1차로 확보합니다.
* **기술 전략**: Vector DB의 메타데이터 인덱스를 활용하여 검색 속도와 정확도를 동시에 확보합니다.

### **3.3 RDB 상세 정보 매핑 및 검증**
* **목표**: Vector DB에서 검색된 결과가 현재 시점에도 유효한지 RDB 마스터 데이터를 통해 최종 확인합니다.
* **검증 및 보강 항목**:
    * **유효성 체크**: RDB의 최신 상태값(사용 여부 등)을 확인하여 폐기된 규정을 제외합니다.
    * **정보 보강**: 답변에 포함될 정식 규정 명칭, 최근 개정일 등 상세 메타데이터를 결합합니다.
    * **권한 검증**: 해당 사용자가 검색된 조항에 접근할 권한이 있는지 최종적으로 확인합니다.

---

## 3. 커서(Cursor) IDE 구현 체크리스트

- [ ] `EmbeddingStoreContentRetriever`를 활용한 기본 검색 로직 구현
- [ ] 질의 분석 DTO를 LangChain4j `Filter` 객체로 변환하는 매퍼 작성
- [ ] 검색 결과의 `rdb_id`를 기반으로 RDB(JPA) 조회를 수행하는 검증 레이어 구축
- [ ] 사후 검증 후 남은 결과가 부족할 경우를 대비한 로깅 및 예외 처리 로직 추가
- [ ] 검색 과정의 가시성(Observability) 확보를 위한 필터링 전/후 데이터 수 로깅 구현