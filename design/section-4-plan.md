# 💾 [P 4.0] 응답 생성 및 이력 관리 상세 계획서

이 프로세스는 검색된 근거 데이터를 바탕으로 사용자에게 최종 답변을 제공하고, 대화의 맥락을 유지하기 위해 세션 및 질의 히스토리를 파일 시스템에 기록하는 마무리를 담당합니다.

---

## 1. 하위 데이터 흐름도 (Level 2 DFD)

(아래 머메이드 코드를 복사하여 문서의 다이어그램 영역에 넣으세요.)

graph TD
    %% 데이터 엔티티 (사각형)
    IN[참조 컨텍스트 데이터]
    User[사용자]

    %% 프로세스 (타원형)
    P4_1(["4.1 프롬프트 구성 (질문+컨텍스트)"])
    P4_2(["4.2 LLM 기반 응답 생성"])
    P4_3(["4.3 세션 및 히스토리 파일 업데이트"])

    %% 파일 엔티티 (파일도형)
    F1{{"사용자 질의 히스토리 (history.json)"}}
    F2{{"사용자 질의 세션 (session.json)"}}

    %% 데이터 흐름
    IN --> P4_1
    P4_1 --> P4_2
    P4_2 -->|최종 답변 전송| User
    P4_2 -->|대화 로그 전달| P4_3
    P4_3 -.->|JSON 쓰기| F1
    P4_3 -.->|세션 메타 갱신| F2


---

## 2. 단계별 상세 구현 가이드

### **4.1 프롬프트 구성 (Prompt Engineering)**
* **목표**: 사용자의 질문과 3번 프로세스에서 넘어온 참조 컨텍스트를 결합하여 LLM이 답변하기 최적의 상태로 만듭니다.
* **핵심 전략**: 'Grounding' 기법을 적용하여 답변의 환각(Hallucination)을 방지합니다.
    * **지시문 예시**: "반드시 제공된 문서의 내용만을 바탕으로 답변할 것", "문서에 정보가 없으면 모른다고 답할 것"
    * **출처 명시**: "답변 시 반드시 제n조 n항이라는 구체적인 출처를 밝힐 것"

### **4.2 LLM 기반 응답 생성 (Response Generation)**
* **목표**: 설정된 프롬프트를 기반으로 자연스럽고 정확한 답변을 생성합니다.
* **구현 방식**: LangChain4j의 AiServices를 활용하여 스트리밍(Streaming) 또는 단일 응답 방식으로 구현합니다.
* **정보 보강**: 답변 본문에 RDB에서 가져온 상세 메타데이터(규정의 정식 명칭, 최신 개정일 등)를 결합하여 정보의 신뢰도를 극대화합니다.

### **4.3 세션 및 히스토리 파일 업데이트 (Logging)**
* **목표**: 대화 내용을 JSON 파일에 기록하여 추후 세션 복구 및 품질 분석에 활용합니다.
* **기록 데이터 포맷**:
    * **history.json**: 질의 원문, 답변 내용, 타임스탬프, 참조된 조항 ID 리스트
    * **session.json**: 세션 식별자, 마지막 질의 일시, 대화 요약 제목

---

## 3. 데이터 포맷 예시 (JSON)

**질의 히스토리 기록 구조**
{
  "sessionId": "SESSION-UUID",
  "query": "신입사원 연차 규정 알려줘",
  "answer": "인사관리규정 제10조에 의거하여...",
  "timestamp": "2026-01-26T23:00:00",
  "referencedDocs": ["REG-001", "REG-012"]
}

---

## 4. 커서(Cursor) IDE 구현 체크리스트

- [ ] LangChain4j ChatLanguageModel 및 AiServices 인터페이스 설정
- [ ] 근거 기반 답변 생성을 위한 시스템 프롬프트 템플릿 작성
- [ ] Jackson 라이브러리를 활용한 JSON 파일 I/O 유틸리티 클래스 구현
- [ ] 파일 쓰기 시 발생할 수 있는 동시성 이슈(Concurrency) 방지 로직 적용
- [ ] 답변 생성 과정에서 발생하는 토큰 사용량 및 소요 시간 로깅 로직 추가