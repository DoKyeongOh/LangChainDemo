# 🔍 [P 2.0] 사용자 질의 분석 상세 계획서

이 프로세스는 사용자의 자연어 질문을 시스템이 이해하고, 검색 필터로 활용할 수 있도록 구조화된 데이터(DTO)로 변환하는 자연어 이해(NLU) 단계를 담당합니다.

---

## 1. 하위 데이터 흐름도 (Level 2 DFD)

(아래 머메이드 코드를 복사하여 문서의 다이어그램 영역에 넣으세요.)

graph TD
    User[사용자]
    MEM[Memory: 질의 분석 DTO]

    P2_1(["2.1 질문 의도(Intent) 분류"])
    P2_2(["2.2 핵심 키워드 및 엔티티 추출"])
    P2_3(["2.3 질의 분석 DTO 생성"])

    User -->|질의 원문 입력| P2_1
    P2_1 --> P2_2
    P2_2 --> P2_3
    P2_3 -->|분석 결과 저장| MEM


---

## 2. 단계별 상세 구현 가이드

### **2.1 질문 의도(Intent) 분류**
* **목표**: 질문이 단순 인사인지, 규정 검색인지, 혹은 특정 동작(예: 요약) 요청인지 파악합니다.
* **핵심 로직**: LLM에게 미리 정의된 의도 카테고리(SEARCH, GREETING, SUMMARY 등) 중 하나를 선택하도록 요청합니다.
* **기능**: 파악된 의도에 따라 후속 프로세스(Vector DB 검색 가동 여부 등)를 결정하여 시스템 효율을 높입니다.

### **2.2 핵심 키워드 및 엔티티 추출**
* **목표**: 질문 내에서 필터링에 사용할 핵심 명사와 조건을 뽑아냅니다.
* **추출 대상**:
    * **주제 키워드**: 예) 연차, 출장비, 경조사
    * **대상 엔티티**: 예) 신입사원, 임원, 팀장
    * **시간 조건**: 예) 작년, 2024년, 개정 전
* **동의어 처리**: 사용자의 다양한 표현을 시스템 표준 키워드(Vector DB 메타데이터에 저장된 키워드)로 매핑합니다.

### **2.3 질의 분석 DTO 생성**
* **목표**: 분석된 정보를 메모리에 상주시켜 검색 프로세스(P 3.0)에서 즉시 쓸 수 있게 포맷팅합니다.
* **DTO 구조 **:
    * userId: 사용자 식별자
    * intent: 파악된 의도 (Enum)
    * rawQuery: 원본 질문
    * extractedKeywords: 추출된 키워드 리스트
    * filters: 대상, 날짜 등 검색 필터 맵

---

## 3. 데이터 저장소 관리 (Memory)

* **저장 대상**: 사용자 질의 분석 DTO
* **특성**:
    * **휘발성**: 대화 세션 중에는 유지되지만, 새로운 질문이 들어오면 갱신됩니다.
    * **고속 접근**: RAG 검색 엔진의 검색 파라미터로 즉시 전달되어 검색 지연을 최소화합니다.

---

## 4. 커서(Cursor) IDE 구현 체크리스트

- [ ] LangChain4j AiServices를 이용한 질의 분석 인터페이스 정의
- [ ] LLM에 전달할 분석용 프롬프트(Few-shot 예시 포함) 작성
- [ ] 분석 결과를 담을 QueryAnalysisDto 레코드 생성
- [ ] 분석 결과가 모호할 경우를 대비한 기본 의도 설정(Fallback) 로직 구현
- [ ] 추출된 키워드를 Vector DB의 메타데이터 필터 형식으로 변환하는 매퍼 작성